<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>xclabel - 数据标注工具</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='all.min.css') }}">
</head>
<body>
    <div class="container">
        <!-- 顶部导航栏 -->
        <header class="navbar">
            <div class="logo">
                <h1 style="cursor: pointer;" onclick="window.location.href='/'"><span class="x">x</span>clabel <span class="version">{{ version }}</span></h1>
            </div>
            <div class="nav-buttons">
                <button id="openFolderBtn" class="btn btn-primary">
                    <i class="fas fa-upload"></i> 添加数据集
                </button>
                                <button id="clearAnnotationBtn" class="btn btn-danger">
                    <i class="fas fa-trash"></i> 清除
                </button>
                <button id="saveAnnotationBtn" class="btn btn-success">
                    <i class="fas fa-save"></i> 保存
                </button>

                <button id="exportBtn" class="btn btn-success">
                    <i class="fas fa-download"></i> 导出数据集
                </button>
                <button id="aiLabelBtn" class="btn btn-primary">
                    <i class="fas fa-robot"></i> AI标注
                </button>
                <button id="aiConfigBtn" class="btn btn-warning">
                    <i class="fas fa-cog"></i> AI配置
                </button>
                <button id="settingsBtn" class="btn btn-info">
                    <i class="fas fa-cog"></i> 设置
                </button>

            </div>
        </header>

        <!-- 主要内容区域 -->
        <div class="main-content">
            <!-- 左侧图片列表 -->
            <div class="image-panel">
                <!-- 调整大小手柄 -->
                <div class="resize-handle" id="resizeHandle"></div>
                
                <!--<div class="panel-header">
                    <h3><i class="fas fa-images"></i> 图片列表</h3>
                </div>-->


                <div class="image-search-container">
                    <div class="search-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="imageSearch" class="search-input" placeholder="搜索图片...">
                    </div>
                    <div class="image-toolbar">
                        <div class="image-stats">
                            <span id="imageCount">共 0 张图片</span>
                        </div>
                        <div class="image-actions">
                            <button id="selectAllBtn" class="btn btn-small btn-secondary" title="全选">
                                <i class="fas fa-check-square"></i>
                            </button>
                            <button id="deleteSelectedBtn" class="btn btn-small btn-danger" title="删除选中" disabled>
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <ul id="imageList" class="image-list">
                    <!-- 图片将通过JavaScript动态加载 -->
                </ul>
            </div>

            <!-- 中间图像显示区域 -->
            <div class="image-container">
                <div id="imageCanvasContainer">
                    <canvas id="imageCanvas"></canvas>
                    <!-- 标注工具 -->
                    <div class="drawing-tools">
                        <button id="rectTool" class="tool-btn active" title="矩形工具">
                            <i class="fas fa-vector-square"></i>
                        </button>
                        <button id="polygonTool" class="tool-btn" title="多边形工具">
                            <i class="fas fa-draw-polygon"></i>
                        </button>
                        <button id="moveTool" class="tool-btn" title="移动工具">
                            <i class="fas fa-arrows-alt"></i>
                        </button>
                    </div>
                </div>
                <div id="noImageMessage" class="no-image-message">
                    <p><i class="fas fa-image fa-3x"></i></p>
                    <p>请选择一张图片开始标注</p>
                </div>
            </div>

            <!-- 右侧标注工具 -->
            <div class="annotation-panel">
                <!--<h3><i class="fas fa-edit"></i> 标注工具</h3>-->

                
                <div class="tool-section">
                    <h4>标签管理</h4>
                    <div class="class-controls">
                        <input type="text" id="newClassInput" placeholder="新标签">
                        <input type="color" id="newClassColor" value="#3aa757" class="color-picker">
                        <button id="addClassBtn" class="btn btn-small btn-primary">
                            <i class="fas fa-plus"></i> 添加
                        </button>
                    </div>
                    <ul id="classList" class="class-list">
                        <!-- 类别将通过JavaScript动态加载 -->
                    </ul>
                </div>

                <div class="tool-section">
                    <h4>标注列表</h4>
                    <ul id="currentAnnotations" class="annotation-list">
                        <!-- 当前标注将通过JavaScript动态加载 -->
                    </ul>
                </div>

                
            </div>
        </div>
    </div>

    <!-- 导出模态框 -->
    <div id="exportModal" class="modal export-modal">
        <div class="modal-content export-modal-content">
            <span class="close">&times;</span>
            <h2><i class="fas fa-download"></i> 导出数据集</h2>
            <form id="exportForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="trainRatio">训练集比例:</label>
                        <input type="number" id="trainRatio" name="trainRatio" min="0" max="1" step="0.1" value="0.7">
                    </div>
                    <div class="form-group">
                        <label for="valRatio">验证集比例:</label>
                        <input type="number" id="valRatio" name="valRatio" min="0" max="1" step="0.1" value="0.2">
                    </div>
                    <div class="form-group">
                        <label for="testRatio">测试集比例:</label>
                        <input type="number" id="testRatio" name="testRatio" min="0" max="1" step="0.1" value="0.1">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>样本选择:</label>
                    <div class="sample-selection">
                        <label>
                            <input type="radio" name="sampleSelection" value="all" checked> 所有图片
                        </label>
                        <label>
                            <input type="radio" name="sampleSelection" value="annotated"> 仅已标注的图片
                        </label>
                        <label>
                            <input type="radio" name="sampleSelection" value="unannotated"> 仅未标注的图片
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>导出数据类型:</label>
                    <div class="export-type-selection">
                        <label>
                            <input type="radio" name="exportDataType" value="yolo" checked> YOLO格式
                        </label>
                        <label class="disabled">
                            <input type="radio" name="exportDataType" value="resnet" disabled> ResNet格式
                        </label>
                        <label class="disabled">
                            <input type="radio" name="exportDataType" value="videonet" disabled> VideoNet格式
                        </label>
                          <label class="disabled">
                            <input type="radio" name="exportDataType" value="audionet" disabled> AudioNet格式
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>类别选择:</label>
                    <div id="classCheckboxes" class="class-checkbox-container">
                        <!-- 类别复选框将通过JavaScript动态加载 -->
                    </div>
                </div>
                
                <!-- 文件前缀和导出按钮在同一行 -->
                <div class="form-row" style="display: flex; align-items: flex-end; gap: 10px;">
                    <div class="form-group" style="width: 200px;">
                        <label for="exportPrefix">导出文件前缀 (可选):</label>
                        <input type="text" id="exportPrefix" placeholder="输入文件前缀" style="width: 100%;">
                    </div>
                    <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                        <button type="submit" class="btn btn-success" id="exportSubmitBtn" style="width: auto; min-width: 100px; height: 36px;">
                            <i class="fas fa-download"></i> 导出
                        </button>
                        <!-- 加载指示器 -->
                        <div id="exportLoadingIndicator" class="loading-indicator" style="display: none; height: 36px; line-height: 36px; margin: 0; padding: 0 10px;">
                            <i class="fas fa-spinner fa-spin"></i> 正在处理...
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- 设置模态框 -->
    <div id="settingsModal" class="modal settings-modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2><i class="fas fa-cog"></i> 设置</h2>
            
            <!-- 作者信息 -->
            <div class="author-info">
                <h3 style="margin: 0 0 10px 0; font-size: 1.1em; color: #555;"><i class="fas fa-user"></i> 关于项目</h3>
                <div class="form-row">
                    <div class="form-group">
                        <strong>作者:</strong> <a href="https://space.bilibili.com/487906612" target="_blank" style="color: #339af0; text-decoration: none;">北小菜</a>
                    </div>
                    <div class="form-group">
                        <strong>版本:</strong> {{ version }}
                    </div>
                </div>
                <div class="form-group">
                    <strong>开源主页:</strong> <a href="https://github.com/beixiaocai/xclabel" target="_blank" style="color: #339af0; text-decoration: none;">GitHub - beixiaocai/xclabel</a>
                </div>
            </div>
            
            <!-- YOLO11安装 -->
            <div class="yolo11-install-section">
                <h3 style="margin: 0 0 15px 0; font-size: 1.1em; color: #555;"><i class="fas fa-robot"></i> YOLO11安装</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="yolo11InstallPath">安装路径:</label>
                        <input type="text" id="yolo11InstallPath" placeholder="请输入YOLO11安装路径" value="plugins/yolo11">
                        <small>默认安装在项目plugins目录下，使用隔离虚拟环境</small>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button type="button" class="btn btn-primary" id="installYolo11Btn">
                        <i class="fas fa-download"></i> 安装YOLO11
                    </button>
                    <button type="button" class="btn btn-danger" id="uninstallYolo11Btn" disabled>
                        <i class="fas fa-trash"></i> 卸载YOLO11
                    </button>
                    <button onclick="window.open('https://beixiaocai.yuque.com/org-wiki-beixiaocai-vo72oa/xclabel/bid4k1lwvva8lzn0', '_blank')" type="button" class="btn btn-info" id="gpuAccelerationBtn">
                        <i class="fas fa-gpu"></i> 如何训练
                    </button>
                </div>
                <div id="yolo11InstallInfo" style="margin-top: 10px; padding: 8px; background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; font-size: 0.9em; display: none;">
                    <!-- 安装信息将通过JavaScript动态填充 -->
                </div>
                <div id="yolo11InstallStatus" style="margin-top: 10px; padding: 8px; background-color: #f8f9fa; border-radius: 4px; font-size: 0.9em; display: none;">
                    <i class="fas fa-info-circle"></i> <span id="yolo11StatusText">安装状态</span>
                </div>
                <div id="yolo11InstallProgress" style="margin-top: 8px; display: none;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                        <span style="font-size: 0.85em; color: #666;">安装进度:</span>
                        <span id="yolo11ProgressPercent">0%</span>
                    </div>
                    <div style="width: 100%; height: 6px; background-color: #e9ecef; border-radius: 3px; overflow: hidden;">
                        <div id="yolo11ProgressBar" style="width: 0%; height: 100%; background-color: #339af0; transition: width 0.3s ease;"></div>
                    </div>
                </div>
                
                <!-- 预训练模型下载 -->
                <div class="yolo11-models-section" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e9ecef;">
                    <h3 style="margin: 0 0 15px 0; font-size: 1.1em; color: #555;"><i class="fas fa-download"></i> 预训练模型</h3>
                    <div style="margin-bottom: 10px;">
                        <label>选择要下载的YOLO11预训练模型:</label>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 8px;">
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" name="yolo11Models" value="yolo11n" checked>
                                YOLO11n (小型)
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" name="yolo11Models" value="yolo11s" checked>
                                YOLO11s (中型)
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" name="yolo11Models" value="yolo11m" checked>
                                YOLO11m (大型)
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" name="yolo11Models" value="yolo11l" checked>
                                YOLO11l (特大型)
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" name="yolo11Models" value="yolo11x" checked>
                                YOLO11x (超大型)
                            </label>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; width: fit-content;">
                        <button type="button" class="btn btn-primary icon-btn" id="downloadModelsBtn">
                            <i class="fas fa-download"></i> <span class="btn-text">下载选中模型</span>
                        </button>
                        <button type="button" class="btn btn-secondary icon-btn" id="refreshModelsBtn">
                            <i class="fas fa-sync-alt"></i> <span class="btn-text">刷新模型列表</span>
                        </button>
                    </div>
                    
                    <!-- 模型列表和拖放区域 -->
                    <div id="modelsContainer" style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 1em; color: #666;">已安装模型:</h4>
                        <div id="modelsList" style="background-color: #f8f9fa; padding: 10px; border-radius: 4px; min-height: 50px; font-size: 0.9em;">
                            <!-- 模型列表将动态生成 -->
                        </div>
                    </div>
                    
                    <!-- 手动拖放区域 -->
                    <div id="modelDropZone" style="border: 2px dashed #ced4da; border-radius: 4px; padding: 20px; text-align: center; background-color: #f8f9fa; margin-bottom: 15px;">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 2em; color: #6c757d; margin-bottom: 10px;"></i>
                        <p style="margin: 0 0 10px 0; color: #6c757d;">如果下载失败，您可以手动将模型文件拖放到此处</p>
                        <p style="margin: 0; font-size: 0.85em; color: #6c757d;">或放置到以下目录:</p>
                        <p style="margin: 5px 0 0 0; font-weight: bold; color: #495057;"><span id="modelsPath">plugins/yolo11/models</span></p>
                    </div>
                    
                    <div id="modelDownloadStatus" style="margin-top: 10px; padding: 8px; background-color: #f8f9fa; border-radius: 4px; font-size: 0.9em; display: none;">
                        <i class="fas fa-info-circle"></i> <span id="modelStatusText">模型下载状态</span>
                    </div>
                </div>
            </div>
            
            <!-- 快捷键设置 -->
            <form id="settingsForm">
                <h3 style="margin: 0 0 15px 0; font-size: 1.1em; color: #555;"><i class="fas fa-keyboard"></i> 快捷键设置</h3>
                <div class="shortcut-section">
                    <div class="form-group">
                        <label for="clearShortcut">清除标注快捷键:</label>
                        <input type="text" id="clearShortcut" placeholder="请输入快捷键组合" value="Ctrl+Shift+D">
                    </div>
                    <div class="form-group">
                        <label for="saveShortcut">保存标注快捷键:</label>
                        <input type="text" id="saveShortcut" placeholder="请输入快捷键组合" value="Ctrl+S">
                    </div>
                    <div class="form-group">
                        <label for="prevImageShortcut">上一张图片快捷键:</label>
                        <input type="text" id="prevImageShortcut" placeholder="请输入快捷键" value="ArrowUp">
                    </div>
                    <div class="form-group">
                        <label for="nextImageShortcut">下一张图片快捷键:</label>
                        <input type="text" id="nextImageShortcut" placeholder="请输入快捷键" value="ArrowDown">
                    </div>
                </div>
                <div style="display: flex; justify-content: flex-start; margin-top: 15px;">
                    <button type="submit" class="btn btn-success" id="saveSettingsBtn">
                        <i class="fas fa-save"></i> 保存设置
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 数据集上传模态框 -->
    <div id="datasetModal" class="modal dataset-modal">
        <div class="modal-content dataset-modal-content">
            <span class="close">&times;</span>
            <h2><i class="fas fa-upload"></i> 添加数据集</h2>
            <div class="dataset-tabs">
                <button class="tab-btn active" data-tab="image">图片文件夹</button>
                <button class="tab-btn" data-tab="video">视频文件</button>
                <button class="tab-btn" data-tab="labelme">labelme数据集</button>
            </div>
            <div class="tab-content">
                <!-- 图片文件夹上传 -->
                <div class="tab-pane active" id="image-tab">
                    <div class="upload-area" id="imageUploadArea">
                        <i class="fas fa-folder-open fa-3x"></i>
                        <p>拖拽图片文件到此处或点击选择文件夹</p>
                        <input type="file" id="folderInput" multiple accept="image/*" style="display: none;">
                        <button id="selectFolderBtn" class="btn btn-primary">选择图片文件</button>
                    </div>
                    <div class="upload-actions" style="margin-top: 15px; text-align: center;">
                        <button id="uploadImagesBtn" class="btn btn-success" disabled>
                            <i class="fas fa-upload"></i> 上传图片到数据集
                        </button>
                    </div>
                </div>
                <!-- 视频文件上传 -->
                <div class="tab-pane" id="video-tab">
                    <div class="upload-area" id="videoUploadArea">
                        <i class="fas fa-video fa-3x"></i>
                        <p>拖拽视频文件到此处或点击选择视频</p>
                        <input type="file" id="videoInput" accept="video/*" style="display: none;">
                        <button id="selectVideoBtn" class="btn btn-primary">选择视频文件</button>
                        <div id="selectedVideoInfo" style="margin-top: 10px; font-size: 0.9em; color: #666; display: none;">
                            <strong>已选择:</strong> <span id="selectedVideoName"></span>
                        </div>
                        
                        <div class="form-group">
                            <label for="frameInterval">抽帧间隔 (帧):</label>
                            <input type="number" id="frameInterval" min="1" max="1000" value="30">
                            <small>每隔指定帧数保存一帧作为样本</small>
                        </div>
                        
                        <button id="extractFramesBtn" class="btn btn-success" disabled>
                            <i class="fas fa-film"></i> 抽帧并添加到数据集
                        </button>
                    </div>
                </div>
                <!-- LabelMe数据集上传 -->
                <div class="tab-pane" id="labelme-tab">
                    <div class="upload-area" id="labelmeUploadArea">
                        <i class="fas fa-file-code fa-3x"></i>
                        <p>拖拽LabelMe数据集文件到此处或点击选择文件夹</p>
                        <input type="file" id="labelmeInput" multiple style="display: none;">
                        <button id="selectLabelMeBtn" class="btn btn-primary">选择labelme数据集</button>
                        <div class="info-text">
                            <p><strong>说明：</strong>请选择包含图片和对应JSON标注文件的labelme数据集文件夹</p>
                        </div>
                    </div>
                    <div class="upload-actions" style="margin-top: 15px; text-align: center;">
                        <button id="uploadLabelMeBtn" class="btn btn-success" disabled>
                            <i class="fas fa-upload"></i> 上传labelme数据集
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑标签模态框 -->
    <div id="editClassModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2><i class="fas fa-edit"></i> 编辑标签</h2>
            <form id="editClassForm">
                <input type="hidden" id="editClassIndex">
                <div class="form-group">
                    <label for="editClassName">标签名称:</label>
                    <input type="text" id="editClassName" placeholder="请输入标签名称">
                </div>
                <div class="form-group">
                    <label for="editClassColor">标签颜色:</label>
                    <input type="color" id="editClassColor" class="color-picker">
                </div>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> 保存更改
                </button>
            </form>
        </div>
    </div>

    <!-- 模型配置模态框 -->
    <div id="modelConfigModal" class="modal model-config-modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2><i class="fas fa-robot"></i> <span id="modelConfigTitle">添加模型配置</span></h2>
            <form id="modelConfigForm">
                <input type="hidden" id="modelConfigId">
                <div class="form-group">
                    <label for="modelConfigName">模型名称:</label>
                    <input type="text" id="modelConfigName" placeholder="请输入模型名称" required>
                </div>
                <div class="form-group">
                    <label for="modelConfigApiKey">API Key:</label>
                    <input type="password" id="modelConfigApiKey" placeholder="请输入API密钥" required>
                </div>
                <div class="form-group">
                    <label for="modelConfigEndpoint">API Endpoint:</label>
                    <input type="text" id="modelConfigEndpoint" placeholder="请输入API端点地址">
                </div>
                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" id="modelConfigDefault">
                        <span>设为默认模型</span>
                    </label>
                </div>
                <div class="form-actions">
                    <button type="button" id="cancelModelConfig" class="btn btn-secondary">
                        <i class="fas fa-times"></i> 取消
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> 保存配置
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast 提示 -->
    <div id="toast" class="toast"></div>
    
    <!-- AI标注弹框 -->
    <div id="aiLabelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-robot"></i> AI标注</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <!-- API配置区域 -->
                <div class="api-config-section">
                    <h3>API配置</h3>
                    <div class="api-config-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="apiTool">推理工具</label>
                                <input type="text" id="apiTool" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label for="apiModel">模型</label>
                                <input type="text" id="apiModel" class="form-control" readonly>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="apiUrl">API地址</label>
                                <input type="text" id="apiUrl" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label for="apiTimeout">超时时间</label>
                                <input type="text" id="apiTimeout" class="form-control" readonly>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 提示词输入区域 -->
                <div class="prompt-section">
                    <h3>提示词</h3>
                    <textarea id="aiPrompt" class="form-control" rows="4" placeholder="请输入标注提示词..."></textarea>
                </div>
                
                <!-- 标签选择区域 -->
                <div class="label-selection-section">
                    <h3>选择标签</h3>
                    <div id="labelList" class="label-list">
                        <!-- 标签将通过JavaScript动态加载 -->
                    </div>
                </div>
                
                <!-- 进度显示区域 -->
                <div id="progressSection" class="progress-section" style="display: none;">
                    <h3>标注进度</h3>
                    <div class="progress-content">
                        <div class="progress-info">
                            <div class="progress-item">
                                <label>已执行：</label>
                                <span id="progressExecuted">0</span> / <span id="progressTotal">0</span>
                            </div>
                            <div class="progress-item">
                                <label>总耗时：</label>
                                <span id="progressTime">0秒</span>
                            </div>
                            <div class="progress-item">
                                <label>状态：</label>
                                <span id="progressStatus">准备中</span>
                            </div>
                        </div>
                        <div class="progress-bar-container">
                            <div id="progressBar" class="progress-bar"></div>
                        </div>
                        <div class="progress-details">
                            <div id="progressDetails"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelAiLabelBtn" class="btn btn-secondary">取消</button>
                <button id="startAiLabelBtn" class="btn btn-primary">开始执行</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    
    <!-- 左侧图片列表宽度调整功能 -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const resizeHandle = document.getElementById('resizeHandle');
            const imagePanel = document.querySelector('.image-panel');
            let isResizing = false;
            let startX = 0;
            let startWidth = 0;
            
            // 从localStorage读取保存的宽度
            const savedWidth = localStorage.getItem('imagePanelWidth');
            if (savedWidth) {
                const width = parseInt(savedWidth);
                // 确保宽度在有效范围内
                if (width >= 150 && width <= 500) {
                    imagePanel.style.width = width + 'px';
                }
            }
            
            resizeHandle.addEventListener('mousedown', function(e) {
                isResizing = true;
                startX = e.clientX;
                startWidth = parseInt(window.getComputedStyle(imagePanel).width);
                
                // 添加全局事件监听
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
                
                // 防止选择文本
                e.preventDefault();
            });
            
            function handleMouseMove(e) {
                if (!isResizing) return;
                
                const deltaX = e.clientX - startX;
                const newWidth = startWidth + deltaX;
                
                // 设置最小和最大宽度限制
                if (newWidth >= 150 && newWidth <= 500) {
                    imagePanel.style.width = newWidth + 'px';
                }
            }
            
            function handleMouseUp() {
                isResizing = false;
                
                // 保存当前宽度到localStorage
                const currentWidth = parseInt(window.getComputedStyle(imagePanel).width);
                localStorage.setItem('imagePanelWidth', currentWidth);
                
                // 移除全局事件监听
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
            }
        });
    </script>
    
    <!-- AI标注功能 -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 获取DOM元素
            const aiLabelBtn = document.getElementById('aiLabelBtn');
            const aiLabelModal = document.getElementById('aiLabelModal');
            const closeBtn = aiLabelModal.querySelector('.close');
            const cancelBtn = document.getElementById('cancelAiLabelBtn');
            const startBtn = document.getElementById('startAiLabelBtn');
            const labelList = document.getElementById('labelList');
            
            // API配置元素
            const apiTool = document.getElementById('apiTool');
            const apiModel = document.getElementById('apiModel');
            const apiUrl = document.getElementById('apiUrl');
            const apiTimeout = document.getElementById('apiTimeout');
            
            // 提示词输入框
            const aiPrompt = document.getElementById('aiPrompt');
            
            // 选中的标签
            let selectedLabel = null;
            
            // 打开AI标注弹框
            aiLabelBtn.addEventListener('click', function() {
                loadApiConfig();
                loadLabels();
                aiLabelModal.style.display = 'block';
            });
            
            // 关闭AI标注弹框
            function closeModal() {
                aiLabelModal.style.display = 'none';
            }
            
            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            
            // 点击弹框外部关闭
            window.addEventListener('click', function(e) {
                if (e.target == aiLabelModal) {
                    closeModal();
                }
            });
            
            // 加载API配置
            function loadApiConfig() {
                fetch('/api/load-api-config')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const config = data.config;
                            apiTool.value = config.inferenceTool || '';
                            apiModel.value = config.model || '';
                            apiUrl.value = config.apiUrl || '';
                            apiTimeout.value = config.timeout || '';
                            aiPrompt.value = config.prompt || '';
                        }
                    })
                    .catch(error => {
                        console.error('Failed to load API config:', error);
                        showToast('加载API配置失败', 'error');
                    });
            }
            
            // 加载标签列表
            function loadLabels() {
                fetch('/api/classes')
                    .then(response => response.json())
                    .then(classes => {
                        labelList.innerHTML = '';
                        
                        classes.forEach(cls => {
                            const labelItem = document.createElement('div');
                            labelItem.className = 'label-item';
                            
                            const radio = document.createElement('input');
                            radio.type = 'radio';
                            radio.name = 'label';
                            radio.value = cls.name;
                            radio.id = `label_${cls.name}`;
                            
                            const label = document.createElement('label');
                            label.htmlFor = radio.id;
                            label.textContent = cls.name;
                            
                            labelItem.appendChild(radio);
                            labelItem.appendChild(label);
                            
                            // 添加选择事件
                            labelItem.addEventListener('click', function() {
                                // 移除其他选中状态
                                document.querySelectorAll('.label-item').forEach(item => {
                                    item.classList.remove('selected');
                                });
                                // 添加当前选中状态
                                labelItem.classList.add('selected');
                                selectedLabel = cls.name;
                            });
                            
                            labelList.appendChild(labelItem);
                        });
                    })
                    .catch(error => {
                        console.error('Failed to load labels:', error);
                        showToast('加载标签失败', 'error');
                    });
            }
            
            // 开始执行AI标注
            startBtn.addEventListener('click', function() {
                if (!selectedLabel) {
                    alert('请选择一个标签');
                    return;
                }
                
                // 获取选中的图片（使用复选框选中的图片）
                const selectedCheckboxes = document.querySelectorAll('.image-checkbox-input:checked');
                let imageNames = [];
                
                if (selectedCheckboxes.length > 0) {
                    // 如果有通过复选框选中的图片，使用这些图片
                    imageNames = Array.from(selectedCheckboxes).map(checkbox => {
                        const listItem = checkbox.closest('.image-item');
                        return listItem.querySelector('.image-name').textContent;
                    });
                } else {
                    // 否则检查是否有通过点击选中的图片（单个）
                    const singleSelectedImage = document.querySelector('#imageList li.selected');
                    if (singleSelectedImage) {
                        imageNames = [singleSelectedImage.querySelector('.image-name').textContent];
                    }
                }
                
                if (imageNames.length === 0) {
                    alert('请至少选中一个文件');
                    return;
                }
                
                // 获取API配置
                const config = {
                    inferenceTool: apiTool.value,
                    model: apiModel.value,
                    apiUrl: apiUrl.value,
                    apiKey: '', // 不显示密钥
                    timeout: parseInt(apiTimeout.value),
                    prompt: aiPrompt.value
                };
                
                // 显示进度区域
                const progressSection = document.getElementById('progressSection');
                progressSection.style.display = 'block';
                
                // 初始化进度显示
                document.getElementById('progressExecuted').textContent = '0';
                document.getElementById('progressTotal').textContent = imageNames.length;
                document.getElementById('progressTime').textContent = '0秒';
                document.getElementById('progressStatus').textContent = '准备中';
                document.getElementById('progressBar').style.width = '0%';
                document.getElementById('progressDetails').textContent = '';
                
                // 发送AI标注请求
                startBtn.disabled = true;
                startBtn.textContent = '执行中...';
                
                // 记录开始时间
                const startTime = Date.now();
                
                // 发送AI标注请求
                fetch('/api/ai-label', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        images: imageNames,
                        label: selectedLabel,
                        apiConfig: config
                    })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        // 计算总耗时
                        const endTime = Date.now();
                        const totalTime = Math.round((endTime - startTime) / 1000);
                        
                        // 更新最终进度
                        document.getElementById('progressExecuted').textContent = result.processed;
                        document.getElementById('progressTime').textContent = `${totalTime}秒`;
                        document.getElementById('progressStatus').textContent = '标注完成';
                        document.getElementById('progressBar').style.width = '100%';
                        document.getElementById('progressDetails').textContent = `成功处理 ${result.processed} 张图片，其中 ${result.labeled} 张标注成功`;
                        
                        showToast('AI标注完成', 'success');
                        
                        // 延迟关闭弹框，让用户看到最终结果
                        setTimeout(() => {
                            // 更新图片列表状态
                            updateImageList();
                            closeModal();
                        }, 1000);
                    } else {
                        showToast(`AI标注失败: ${result.error}`, 'error');
                        document.getElementById('progressStatus').textContent = '标注失败';
                    }
                })
                .catch(error => {
                    console.error('AI label failed:', error);
                    showToast('AI标注失败', 'error');
                    document.getElementById('progressStatus').textContent = '标注失败';
                })
                .finally(() => {
                    startBtn.disabled = false;
                    startBtn.textContent = '开始执行';
                });
            });
            
            // 更新图片列表
            function updateImageList() {
                // 触发图片列表更新
                if (typeof loadImages === 'function') {
                    loadImages();
                }
            }
            
            // SocketIO连接
            const socket = io();
            
            // 监听AI标注进度更新
            socket.on('ai_label_progress', function(data) {
                // 更新进度显示
                document.getElementById('progressExecuted').textContent = data.processed || 0;
                document.getElementById('progressTotal').textContent = data.total || 0;
                document.getElementById('progressTime').textContent = `${data.elapsed_time || 0}秒`;
                document.getElementById('progressStatus').textContent = data.message || '准备中';
                
                // 更新进度条
                if (data.total > 0 && data.processed > 0) {
                    const progressPercentage = Math.round((data.processed / data.total) * 100);
                    document.getElementById('progressBar').style.width = `${progressPercentage}%`;
                }
            });
            
            // 显示提示信息
            function showToast(message, type = 'info') {
                // 使用现有的toast功能
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast ${type}`;
                toast.style.display = 'block';
                
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 3000);
            }
        });
    </script>
</body>
</html>